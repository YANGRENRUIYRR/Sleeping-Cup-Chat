<!DOCTYPE html>
<html>
<head>
  <title>Sleeping Cup 聊天室</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome图标 -->
  <link href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 引入SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- 配置Tailwind自定义颜色 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36BFFA',
            system: '#6B7280',
            light: '#F9FAFB',
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .message-in {
        animation: fadeIn 0.3s ease-in;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-inter min-h-screen">
  <div class="max-w-3xl mx-auto px-4 py-8">
    <div class="bg-white rounded-xl overflow-hidden shadow-lg">
      <div class="bg-primary text-white p-4">
        <h1 class="text-xl font-bold flex items-center">
          <i class="fa fa-comments mr-2"></i>Sleeping Cup 聊天室
        </h1>
      </div>
      
      <div id="login" class="p-8 text-center">
        <div class="mb-6">
          <i class="fa fa-user-circle text-6xl text-primary/70"></i>
        </div>
        <h2 class="text-xl font-semibold text-gray-800 mb-4">请登录聊天室</h2>
        <div class="flex gap-3 max-w-md mx-auto">
          <input 
            type="text" 
            id="usernameInput" 
            placeholder="输入您的用户名"
            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
          >
        </div>
        <!-- 新增密码输入框 -->
        <div class="flex gap-3 max-w-md mx-auto mt-4">
          <input
            type="password"
            id="passwordInput"
            placeholder="输入密码（仅限有密码用户）"
            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
          >
        </div>
        <div class="mt-4 max-w-md mx-auto">
          <button 
            onclick="login()"
            class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg transition-all font-medium w-full"
          >
            登录
          </button>
        </div>
      </div>
      
      <div id="chat" class="hidden flex flex-col h-[600px]">
        <div id="chatArea" class="flex-1 p-4 overflow-y-auto space-y-4 bg-gray-50"></div>
        
        <div class="border-t p-4 bg-white">
          <div class="flex gap-3 mb-3">
            <span class="text-sm text-gray-600">
              <i class="fa fa-users text-primary mr-1"></i>
              在线用户: <span id="userList" class="font-medium"></span>
            </span>
          </div>
          
          <div class="flex gap-3">
            <input 
              type="text" 
              id="messageInput" 
              placeholder="输入消息，按Enter发送"
              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
            >
            <button 
              onclick="sendMessage()"
              class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg transition-all flex items-center gap-2 font-medium"
            >
              <i class="fa fa-paper-plane"></i>
              <span>发送</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let username = '';
    
    function login() {
      username = document.getElementById('usernameInput').value.trim();
      // 新增：检查用户名长度，最多16字符
      if (username.length > 16) {
        Swal.fire({
          title: '提示',
          text: '用户名最多16字符',
          icon: 'info',
          confirmButtonColor: '#165DFF'
        });
        return;
      }
      const password = document.getElementById('passwordInput').value;
      if (username) {
        socket.emit('login', { username, password });
        document.getElementById('login').style.display = 'none';
        document.getElementById('chat').style.display = 'flex';
        document.getElementById('messageInput').focus();
      }
    }
    
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (message) {
        socket.emit('message', message);
        input.value = '';
      }
    }
    
    // 按Enter发送消息
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    
    // 接收消息
    socket.on('message', (data) => {
      const chatArea = document.getElementById('chatArea');
      const isCurrentUser = data.username === username;
      // 如果消息中包含@当前用户名且非自己发的，则标记为at被提及
      const atHighlight = (!isCurrentUser && data.content.includes("@" + username));
      const alignClass = isCurrentUser ? 'justify-end' : 'justify-start';
      const bgClass = atHighlight ? 'bg-blue-200 text-dark' : (isCurrentUser ? 'bg-primary text-white' : 'bg-gray-200 text-dark');
      chatArea.innerHTML += `
        <div class="message-in flex ${alignClass}">
          <div class="${bgClass} p-3 rounded-lg shadow-sm max-w-[80%]">
            <div class="font-semibold ${isCurrentUser ? 'text-white/90' : 'text-primary'}">
              ${data.username}
              <span class="text-xs opacity-70 ml-2">${data.time}</span>
            </div>
            <div class="mt-1 text-left">${data.content}</div>
          </div>
        </div>
      `;
      chatArea.scrollTop = chatArea.scrollHeight;
    });
    
    socket.on('at', (data) => {
      Swal.fire({
        title: '有人@你',
        text: `您被 ${data.from} 提及了`,
        icon: 'info',
        confirmButtonColor: '#165DFF'
      });
    });
    
    // 系统消息
    socket.on('system', (message) => {
      const chatArea = document.getElementById('chatArea');
      chatArea.innerHTML += `
        <div class="message-in flex justify-center">
          <div class="bg-gray-100 text-system text-sm px-4 py-2 rounded-full">
            ${message}
          </div>
        </div>
      `;
      chatArea.scrollTop = chatArea.scrollHeight;
    });
    
    // 用户列表更新
    socket.on('userList', (users) => {
      document.getElementById('userList').textContent = users.join(', ');
    });
    
    // 错误消息
    socket.on('error', (message) => {
      Swal.fire({
        title: '错误',
        text: message,
        icon: 'error',
        confirmButtonColor: '#165DFF'
      }).then(() => {
        if(message=='密码错误'||message=='用户名包含非ASCII字符'||message=='该用户名已登录'||message=='您已被封禁'||message=='用户名最多16字符'){
          document.getElementById('login').style.display = '';
          document.getElementById('chat').style.display = 'none';
          document.getElementById('usernameInput').focus();
        }
      });
    });
  </script>
</body>
</html>
